<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Pager - Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1a2a6c, #8E2DE2); color: white; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 15px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #ff8a00; }
        .card { background: rgba(0, 0, 0, 0.3); border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn { background: linear-gradient(135deg, #ff8a00, #e52e71); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .btn-danger { background: linear-gradient(135deg, #e52e71, #b21f1f); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        th { background: rgba(255, 255, 255, 0.1); font-weight: 600; }
        .status-read { color: #00b09b; }
        .status-unread { color: #e52e71; }
        .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-select { background: rgba(255, 255, 255, 0.1); color: white; border: none; padding: 8px 15px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üëë Admin Panel</h1>
            <div>
                <span>Welcome, <strong id="adminUser"></strong></span>
                <button class="btn" onclick="logout()" style="margin-left: 15px;">üö™ Logout</button>
            </div>
        </header>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalMessages">0</div>
                <div>Total Messages</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unreadMessages">0</div>
                <div>Unread Messages</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeUsers">0</div>
                <div>Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayMessages">0</div>
                <div>Messages Today</div>
            </div>
        </div>
        
        <div class="card">
            <h2 style="margin-bottom: 20px;">üìä Message Logs</h2>
            <div class="filters">
                <select class="filter-select" id="userFilter" onchange="filterLogs()">
                    <option value="">All Users</option>
                </select>
                <select class="filter-select" id="actionFilter" onchange="filterLogs()">
                    <option value="">All Actions</option>
                    <option value="sent">Sent</option>
                    <option value="read">Read</option>
                </select>
                <button class="btn" onclick="exportLogs()">üì• Export Logs</button>
                <button class="btn btn-danger" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>Sender</th>
                            <th>Receiver</th>
                            <th>Message</th>
                            <th>Priority</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="logsTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser || currentUser.role !== 'admin') {
            window.location.href = 'index.html';
        }

        document.getElementById('adminUser').textContent = currentUser.username;

        function updateStats() {
            const messages = JSON.parse(localStorage.getItem('pagerMessages') || '[]');
            const totalMessages = messages.length;
            const unreadMessages = messages.filter(msg => !msg.read).length;
            const today = new Date().toDateString();
            const todayMessages = messages.filter(msg => new Date(msg.timestamp).toDateString() === today).length;
            const uniqueUsers = [...new Set(messages.flatMap(msg => [msg.sender, msg.receiver]))].length;
            
            document.getElementById('totalMessages').textContent = totalMessages;
            document.getElementById('unreadMessages').textContent = unreadMessages;
            document.getElementById('activeUsers').textContent = uniqueUsers;
            document.getElementById('todayMessages').textContent = todayMessages;
        }

        function displayLogs() {
            const logs = JSON.parse(localStorage.getItem('adminLogs') || '[]');
            const userFilter = document.getElementById('userFilter').value;
            const actionFilter = document.getElementById('actionFilter').value;
            
            let filteredLogs = logs;
            if (userFilter) filteredLogs = filteredLogs.filter(log => log.sender === userFilter || log.receiver === userFilter);
            if (actionFilter) filteredLogs = filteredLogs.filter(log => log.action === actionFilter);
            
            filteredLogs.sort((a, b) => b.id - a.id);
            const tbody = document.getElementById('logsTable');
            tbody.innerHTML = filteredLogs.map(log => `
                <tr>
                    <td>${log.timestamp}</td>
                    <td><span style="background: ${log.action === 'sent' ? '#ff8a00' : '#00b09b'}; padding: 4px 8px; border-radius: 10px; font-size: 0.8rem;">${log.action.toUpperCase()}</span></td>
                    <td>${log.sender}</td>
                    <td>${log.receiver}</td>
                    <td>${log.message}</td>
                    <td><span style="background: ${getPriorityColor(log.priority)}; padding: 4px 8px; border-radius: 10px; font-size: 0.8rem;">${log.priority.toUpperCase()}</span></td>
                    <td class="${log.read ? 'status-read' : 'status-unread'}">${log.read ? '‚úÖ Read' : '‚óè Unread'}</td>
                </tr>
            `).join('');
            
            updateUserFilter(logs);
        }

        function updateUserFilter(logs) {
            const userFilter = document.getElementById('userFilter');
            const uniqueUsers = [...new Set(logs.flatMap(log => [log.sender, log.receiver]))];
            const currentSelection = userFilter.value;
            userFilter.innerHTML = '<option value="">All Users</option>' + uniqueUsers.map(user => `<option value="${user}">${user}</option>`).join('');
            if (uniqueUsers.includes(currentSelection)) userFilter.value = currentSelection;
        }

        function filterLogs() { displayLogs(); }

        function exportLogs() {
            const logs = JSON.parse(localStorage.getItem('adminLogs') || '[]');
            const csv = convertToCSV(logs);
            downloadCSV(csv, 'pager-logs.csv');
        }

        function convertToCSV(logs) {
            const headers = ['Timestamp', 'Action', 'Sender', 'Receiver', 'Message', 'Priority', 'Status'];
            const rows = logs.map(log => [log.timestamp, log.action, log.sender, log.receiver, `"${log.message}"`, log.priority, log.read ? 'Read' : 'Unread']);
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function clearLogs() {
            if (confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
                localStorage.removeItem('adminLogs');
                localStorage.removeItem('pagerMessages');
                displayLogs();
                updateStats();
                alert('All logs have been cleared.');
            }
        }

        function getPriorityColor(priority) {
            return { high: '#e52e71', medium: '#ff8a00', low: '#1a2a6c' }[priority] || '#1a2a6c';
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        function refreshData() {
            updateStats();
            displayLogs();
        }

        window.addEventListener('load', () => {
            refreshData();
            setInterval(refreshData, 5000);
        });
    </script>
</body>
</html>
